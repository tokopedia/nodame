/**
 * @author  Argi Karunia <arugikaru@yahoo.co.jp>
 * @author  Teddy Hong <teddy.hong11@gmail.com>
 * @link    https://github.com/tokopedia/nodame
 * @license http://opensource.org/licenses/MIT
 *
 * @version 1.0.0
 */

var path    = require('path');

function router (app) {
    var appName       = nodame.config('app.name');
    var defaultModule = nodame.config('module.default');
    var modules       = nodame.config('module.items');
    var appRoute      = '/' + appName;
    //sesssion
    var session       = require('nodame/session');
    app.use(session.initSession);

    //set res.locals
    app.use(function (req, res, next) {
        //refback
        var refback;
        if (req.query.refback) {
            refback = req.query.refback;
            res.locals.refback = refback;
        }

        next();
    });

    var handlers = [];

    for (var module in modules) {
        var __config = modules[module];

        if (__config.enable) {
            if (__config.dev_only && !nodame.isDev()) {
                continue;
            }

            var __handler = nodame.handler(module);
            var route     = appRoute + '/';
            var routeDef;

            if (module != defaultModule) {
                route += module + '/';
            } else {
                routeDef = route + module + '/';
            }

            // Init middleware
            if (__config.middleware) {
                var middleware = nodame.middleware(module);
                app.use(route, middleware.init);
            }

            // Init module, only if it's not set as xhr only
			var xhrOnly = __config.ajax && __config.xhr_only ? true : false;

            if (!xhrOnly) {
                app.use(route, __handler);

                // Enable access to default route using its module name
                if (module == defaultModule) {
                    app.use(routeDef, __handler);
                }
            }

            // Init ajax
            if (__config.ajax) {
                var ajaxRoute = appRoute + '/ajax/' + module + '/';
                app.use(ajaxRoute, __handler);
            }
        }
    }

    // Redirect '/' to 'home'
    if (nodame.config('view.redirect_404')) {
        app.use('/', function (req, res) {
            var hostname = nodame.config('url.hostname');
            var url = hostname + path.normalize('/' + appName);
            res.redirect(url);
        });
    }
}

module.exports = router;
